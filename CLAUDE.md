# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

A [chezmoi](https://www.chezmoi.io/) dotfiles repository managing zsh shell configuration across macOS and Linux machines. Chezmoi manages files in `~/.local/share/chezmoi` (the source directory) and applies them to `$HOME` (the target directory).

## Common Commands

- `chezmoi apply` — apply source state to home directory
- `chezmoi apply -n` — dry-run (preview changes without applying)
- `chezmoi diff` — show what would change on next apply
- `chezmoi edit <target-file>` — edit the source file for a target (e.g., `chezmoi edit ~/.zshrc.include`)
- `chezmoi add <file>` — add a new file from home to chezmoi management
- `chezmoi execute-template < file.tmpl` — test template rendering

## Chezmoi Naming Conventions

Files use chezmoi's naming scheme — understand these prefixes:
- `dot_` → `.` (e.g., `dot_zshrc` → `~/.zshrc`)
- `.tmpl` suffix → Go template, rendered at apply time
- `run_onchange_` prefix → run script, executed only when the script contents change
- `run_after_` prefix → run script, executed after target files are updated
- `.chezmoiexternal.toml.tmpl` → external dependencies (downloaded archives)
- `.chezmoi.toml.tmpl` → per-machine config (prompted on first run)

## Template Data

Two boolean flags are set per-machine (prompted on first `chezmoi init`), defined in `.chezmoi.toml.tmpl`:
- `.has_internet` — whether the machine can reach the internet (controls `exact` mode on external archives)
- `.is_work` — work machines pull plugins from `gitlab.example.com/mirrors/`, personal machines from GitHub

OS is available via `.chezmoi.os` (`"darwin"` or `"linux"`).

## Architecture

- **`dot_zshrc`** — main zsh config (static, not a template). Loads oh-my-zsh, plugins, powerlevel10k theme, then sources `~/.zshrc.include`.
- **`dot_zshrc.include.tmpl`** — template with OS-conditional blocks (PATH, aliases, functions, keybindings). Sources all `*.zsh` files from `~/.zshrc.include.d/` for local unmanaged customization.
- **`dot_fzf.zsh`** — fzf setup and keybindings.
- **`dot_p10k.zsh`** — powerlevel10k prompt config (large, auto-generated by `p10k configure`).
- **`.chezmoiexternal.toml.tmpl`** — manages oh-my-zsh and all custom plugins as external archives with 168h refresh. Uses work/personal URL branching.
- **`dot_config/`** — managed config files for tools (kitty, zellij, atuin). Deployed to `~/.config/`.
- **`.chezmoiscripts/`** — all run scripts live here (chezmoi's special directory for scripts that don't create a corresponding dir in `$HOME`). All use `run_onchange_` (re-run only when script contents change) or `run_after_` (run after targets update).
  - `run_onchange_check-tools.sh.tmpl` — Linux-only, checks for required CLI tools (rg, fzf, bat, eza).
  - `run_onchange_check-claude-code.sh.tmpl` — Linux-only, checks for Claude Code CLI.
  - `run_onchange_check-zellij.sh.tmpl` — checks for zellij terminal multiplexer.
  - `run_onchange_check-nvim-deps.sh.tmpl` — checks for neovim and its build dependencies.
  - `run_onchange_check-atuin.sh.tmpl` — non-work/internet only, auto-installs atuin shell history.
  - `run_onchange_set-default-shell.sh.tmpl` — Linux-only, sets zsh as default shell.
  - `run_onchange_before_decrypt-age-key.sh.tmpl` — decrypts age-encrypted SSH key on change.
  - `run_after_patch-nvim-config.sh.tmpl` — macOS-only, patches kickstart.nvim to enable Nerd Font.

## Key Patterns

- OS-conditional blocks use `{{- if eq .chezmoi.os "darwin" }}` / `{{- if eq .chezmoi.os "linux" }}`.
- Work/personal branching uses `{{- if .is_work }}`.
- Tool check scripts are gated to specific platforms via template conditionals — macOS generally assumes tools are pre-installed via Homebrew.
- Local per-machine customizations go in `~/.zshrc.include.d/*.zsh` (not chezmoi-managed, just a `.gitkeep`).
- **Prefer runtime `command -v` over template conditionals in shell config.** When sourcing or initializing a tool in `dot_zshrc.include.tmpl`, gate on `if command -v <tool> >/dev/null 2>&1` rather than chezmoi template `{{ if }}` blocks. This makes the config future-proof — the tool activates automatically once installed, regardless of which machine profile deployed the file. Reserve template conditionals for install scripts and platform-specific paths/settings.
